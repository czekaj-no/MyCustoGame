{% extends 'store/account_base.html' %}
{% load static %}
{% block account_content %}

<h2>📲 Twoje kody QR</h2>

{% if messages %}
  <div class="messages">
    {% for message in messages %}
      <div class="message {{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

{% for entry in items %}
  <div class="qr-box">
    <h3>{{ entry.item.product.category.name }} → <strong>{{ entry.item.product.title }}</strong></h3>

    {% for qr in entry.qrs %}
      <div class="qr-preview">
        <h4>Sztuka {{ forloop.counter }}</h4>

        {% if qr.image %}
          <img src="{{ qr.image.url }}" width="200" alt="Kod QR">
          <br>
          <a href="{{ qr.image.url }}" download class="cta-button small">⬇️ Pobierz kod</a>
        {% else %}
          <p class="qr-status qr-warning">⚠️ Wygenerujemy kod QR, gdy wkleisz i zatwierdzisz link.</p>
        {% endif %}

        {% if qr.url %}
          <p><strong>Link docelowy:</strong> <a href="{{ qr.url }}" target="_blank">{{ qr.url }}</a></p>
        {% else %}
          <p class="qr-status">🔗 Przypisz i zatwierdź link.</p>
        {% endif %}

        {% if qr.url and qr.was_edited %}
          <p class="qr-status">🔒 Link został już raz zmieniony – nie możesz go edytować ponownie.</p>
        {% else %}
          <form method="post" class="qr-form">
            {% csrf_token %}
            <input type="hidden" name="qr_id" value="{{ qr.id }}">
            <input type="url"
                   name="url"
                   placeholder="{% if qr.url %}Wprowadź nowy link (możesz zmienić tylko raz){% else %}Wklej link (np. do Google Drive){% endif %}"
                   required>
            <button type="submit" class="cta-button">
              {% if qr.url %}Zmień link{% else %}Zatwierdź link{% endif %}
            </button>
          </form>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% endfor %}

{% endblock %}
